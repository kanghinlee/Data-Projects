---
title: "Deloitte Productivity Cleaning Script"
output: html_notebook
---
### Library
```{r}
library(tidyverse)
library(janitor)
library(readxl)
library(here)
library(lubridate)
library(slider)
library(infer)
library(scales)
library(zoo)
```

### Functions
```{r}
multiplesheets <- function(fname) {
   
  # getting info about all excel sheets
  sheets <- readxl::excel_sheets(fname)
  tibble <- lapply(sheets, function(x) readxl::read_excel(fname, sheet = x))
  data_frame <- lapply(tibble, as.data.frame)
    
  # assigning names to data frames
  names(data_frame) <- sheets
    
  # print data frame
  print(data_frame)
}
  
# specifying the path name
```

# Meta Data for Productivity Estimates: UK
```{r}
# raw - Raw Files
# pro - Productivity
# Hist - Historical

raw_sic_identify <- multiplesheets(here("data/raw_data/sic07_identifer.xlsx")) 

sic_identify <- raw_sic_identify$Sheet1 %>% 
  rename_with(~ gsub('Sheet2.', '', .x))

sic_identify_2 <- raw_sic_identify$Sheet2 %>% 
  rename_with(~ gsub('Sheet2.', '', .x))

raw_pro_indu <- multiplesheets(here("data/raw_data/uk_Labour Productivity - Industry division_2021.xlsx"))

raw_pro_hist <- multiplesheets(here("data/raw_data/uk_labour_productivity_historical.xls"))

raw_pro_regi <- multiplesheets(here("data/raw_data/uk_Labour Productivity - Region by Industry.xls"))

raw_pro_area <- multiplesheets(here("data/raw_data/uk_labour productivity - Rural and urban areas.xls"))

raw_pro_educ <- multiplesheets(here("data/raw_data/uk_labour_productivity_education_2019.xlsx"))

raw_pro_tim  <- multiplesheets(here("data/raw_data/uk_GDP Estimates - Time Series.xlsx"))

# <- multiplesheets("data/raw_data/")

# tt <- read.delim2("data/deloitte_data_dictionary_2019.numbers", header = FALSE)

raw_world_euro <- multiplesheets(here("data/raw_data/International Labour Productivity - Europe.xls"))

raw_world_g7 <- multiplesheets(here("data/raw_data/international_labour_productivity_G7_2020.xlsx"))

raw_world_multi <- multiplesheets(here("data/raw_data/OECD_multifactor_productivity.xls"))
```


# Europe UK Data
```{r}
# Europe Output Per Hour
# Table 1: Output per hour by industry, €

clean_world_euro_oph <- raw_world_euro$`Table 1` %>% 
  na.omit() %>% 
  row_to_names(row_number = 1) %>% 
  clean_names()

# Table 2: Labour Productivity Growth by industry 2014-16, %
clean_world_euro_growth <- raw_world_euro$`Table 2` %>% 
  na.omit() %>% 
  row_to_names(row_number = 1) %>% 
  clean_names()

```


# Time Series
```{r}
clean_pro_time_year <- raw_pro_tim$data %>% 
  clean_names() %>% 
  filter(!grepl(' Q+[0-9]', title))

clean_pro_time_quart <- raw_pro_tim$data %>% 
  clean_names() %>% 
  filter(!grepl('^\\d{4}$', title))
```


```{r}
clean_world_multi <- as.data.frame(raw_world_multi$DP_LIVE_25012019175641197) %>% 
  clean_names() %>% 
  select(-flag_codes)
```

# G7, whole economy, current price (CP) in GBP
# G7 - Output per hours Productivity
```{r}
# Annual output per hour worked 
g7_prod <- raw_world_g7$Table_9 %>% 
  na.omit() %>% 
  row_to_names(row_number = 1) %>% 
  clean_names() %>% 
  pivot_longer(!year, names_to = "country", values_to = "productivity") %>% 
  mutate(productivity = round(as.numeric(productivity), digits = 2),
         country = str_to_title(country))

g7_prod_avg <- g7_prod %>% 
  group_by(year) %>% 
  summarise(productivity = round(mean(productivity), digits = 2))

g7_prod %>% 
  filter(country == "Uk") %>% 
  ggplot()+
  aes(x = year, y = productivity, group = country, colour = "brown2")+
  geom_point()+
  geom_line()+
  geom_line(aes(x = g7_prod_avg$year, y = g7_prod_avg$productivity, group = country), linetype = 2, colour = "black")+
  labs(title = "Productivity in G7 Countries")+
  xlab("Year")+
  ylab("Output Per Hour Worked (£)")+
  theme(axis.text.x = element_text(angle = 45))+
  theme(legend.position="bottom")
```

# G7 - Output Per Hour wored growth
```{r}
g7_prod_growth <- raw_world_g7$Table_16 %>% 
  na.omit() %>% 
  row_to_names(row_number = 1) %>% 
  clean_names()%>% 
  mutate(across(c(2:8), as.numeric)) %>% 
  pivot_longer(!year, names_to = "country", values_to = "growth_rate")


g7_avg_prod_growth <- g7_prod_growth%>% 
  filter(country != "uk") %>% 
  group_by(year) %>% 
  summarise(g7_avg = mean(growth_rate))%>% 
   mutate(
    moving_avg = slide_dbl(
      .x = g7_avg,
      .f = ~mean(.,na.rm = TRUE),
# 2 weeks moving average
      .before = 2
    )  )


g7_prod_growth %>% 
  filter(country == "uk") %>% 
   mutate(
    moving_avg = slide_dbl(
      .x = growth_rate,
      .f = ~mean(.,na.rm = TRUE),
      # 2 weeks moving average
      .before = 2
                        )) %>% 
  ggplot()+
  aes(x = year, y = moving_avg, group = country, colour = country)+
  geom_point()+
  geom_line()+
  geom_line(aes(x = g7_avg_prod_growth$year, y = g7_avg_prod_growth$moving_avg, group = country, colour = country), linetype = 2, colour = "black", size = 1)+
  geom_vline(aes(xintercept = "2008"), linetype = "longdash", alpha = 0.5)+
  geom_vline(aes(xintercept = "2018"), linetype = "longdash", alpha = 0.5)+
    annotate(geom = "text",
             label = c("Recession"),
             x = c("2005"),
             y = c(2.25),
             vjust = 1,
           hjust = -.05) +
    annotate(geom = "text",
             label = c("Pandemic"),
             x = c("2015"),
             y = c(2.25),
             vjust = 1,
           hjust = -.05) +  
  
  labs(title = "2 Years Moving Average Grow Rate",
       subtitle = "Comparison between UK and Other G7 Countries")+
  xlab("Year")+
  ylab("Growth Rate Per year (%)")+
  theme(axis.text.x = element_text(angle = 45))+
  theme(legend.position="bottom")

```
# G7 - GVD
```{r}
raw_oecd_gva <- read_csv("data/raw_data/OECD_gva.csv") %>% 
  rename(country = "Country Name")

oecd_gva_g7 <- raw_oecd_gva %>% 
  filter(country %in% c("Canada", "France", "Germany", "Italy", "Japan", "United Kingdom", "United States")  ) %>% 
  select(-c(2:41)) %>% 
  pivot_longer(!country, names_to = "year", values_to = "gva") %>% 
  drop_na() %>% 
  # Exchange rate ~$1 = £0.77 and in millions
  mutate(gva = gva*0.77 / 1000000)


oecd_gva_g7 %>% 
  ggplot()+
  aes(x = year, y = gva, group = country, colour = country)+
  geom_line()+
  labs(title = "GVA in G7 Countries")+
  xlab("Year")+
  ylab("GVA (in million £)")+
  scale_color_manual(values = c("United Kingdom" = "red", "France" = "green"))+
  theme(axis.text.x = element_text(angle = 45))


g7_prod %>% 
  ggplot()+
  aes(x = year, y = productivity, group = country, colour = country)+
  geom_line()+
  labs(title = "Productivity in G7 Countries")+
  xlab("Year")+
  ylab("Output Per Hour Worked (£)")+
  theme(axis.text.x = element_text(angle = 45))+
  scale_color_manual(values = c("Uk" = "red", "France" = "green"))


uk_france_diff_prod <- g7_prod %>% 
  filter(country %in% c("Uk", "France")) %>% 
  pivot_wider(names_from = country, values_from = productivity) %>% 
  mutate(diff_in_prod = 100*((France / Uk)-1))

uk_france_diff_gva <- oecd_gva_g7 %>% 
    filter(country %in% c("United Kingdom", "France")) %>% 
  pivot_wider(names_from = country, values_from = gva) %>% 
  rename(Uk = 'United Kingdom') %>% 
  mutate(diff_in_gva = 100*((France / Uk)-1))


uk_france_diff_prod %>% 
  cbind( diff_in_gva = uk_france_diff_gva$diff_in_gva) %>% 
  pivot_longer(!c(1:3), names_to = "factor", values_to = "diff_percent") %>% 
  ggplot()+
    aes(x = year, y = diff_percent, group = factor, colour = factor)+
    geom_line()+
    geom_point()+
  geom_hline(yintercept = 0, linetype = "dashed")+
  labs(title = "Difference in GVA & Productivity between France and UK")+
  xlab("Year")+
  ylab("Percentage Difference (%)")+
  theme(axis.text.x = element_text(angle = 45))

```
Note: Among all the G7 countries, We will be using France as a comparison and find out factors that we can increase productivity in.
France has a similar size in terms of the country and population. In the graph of difference in GVA and Productivity, you can see from the red line, GVA, that France has a lower GVA (net output) when compared to the UK, and yet the productivity gap is increasing since 2008 and onwards.
In this comparison, we can reduce any confounding variables...



# UK productivity Per Industry Divison
```{r}
# GVA Per Hour Worked in £
clean_pro_indu_gvaph <- raw_pro_indu$`GVA CP` %>% 
  # Remove redundant columns
  slice(-c(1,2,3,5)) %>% 
  row_to_names(row_number = 1) %>% 
  rename(year = "SIC07:") %>% 
  pivot_longer(!year, names_to = "sic07", values_to = "oph") %>% 
  mutate(oph = round(as.numeric(oph), digits = 2)) %>% 
  left_join(sic_identify, by = "sic07") %>% 
  select(-c("sic07", "description")) %>% 
  relocate(cat, .before = "oph") %>% 
  separate(year, c("year", "quarter"), " ") %>% 
  group_by(year, cat) %>% 
  summarise(oph = round(mean(oph), digits = 2)) %>% 
  mutate(show_we = case_when(
                    cat == "WE" ~ TRUE,
                    TRUE ~ FALSE))
  
clean_pro_indu_gvaph_rate <- clean_pro_indu_gvaph %>% 
    ungroup() %>% 
    group_by(cat) %>% 
  mutate(rate = (oph - lag(oph))/lag(oph))
  

clean_pro_indu_gvaph %>%
  filter(cat != "L" & cat != "WE") %>%
  ggplot()+
  geom_line(aes(x = year, y  = oph, group = cat, colour = cat))+
  geom_point(aes(x = year, y  = oph, group = cat, colour = cat))+
  labs(title = "GVA per industry in UK")+
  xlab("Year")+
  ylab("GVA Per Hour Worked (£)")+
  theme(axis.text.x = element_text(angle = 45))+
  scale_linetype_manual(values = c("TRUE" = "dashed", "FALSE" = "solid"))+
  guides(linetype = FALSE)

```
A	   Agriculture, forestry and fishing
B-E	 Engineering Industry
F    Construction Industry
G-I	 Wholesale and retail trade, transport, accommodation and food service activities
J	   Information and communication
K	  Financial and insurance activities
L   Real Estate
M-N 	Professional, scientific and technical activities; administrative and support service activities
O-Q	 Public administration, defense, education, human health and social work activities
R-U	 Arts, entertainment and recreation; other service activities


# Minimum and Average Wage
```{r}
raw_oecd_min_wage <- multiplesheets(here("data/raw_data/OECD_real_minimum_wages_2020.xlsx"))

oecd_min_wage <- raw_oecd_min_wage$`OECD.Stat export` %>% 
  row_to_names(row_number = 1) %>% 
  filter(Country %in% c("France", "United Kingdom")) %>% 
  pivot_longer(!1, names_to = "year", values_to = "min_wage") %>% 
  clean_names() %>% 
  mutate(min_wage = round(as.numeric(min_wage), digits = 2))



raw_oecd_avg_wage <- multiplesheets(here("data/raw_data/OECD_average_wages_2020.xlsx"))

oecd_avg_wage <- raw_oecd_avg_wage$`OECD.Stat export` %>% 
  row_to_names(row_number = 1) %>% 
  filter(Unit %in% "US Dollar, 2020", Country %in% c("France", "United Kingdom")) %>% 
  select(-Unit) %>% 
  pivot_longer(!1, names_to = "year", values_to = "avg_wage") %>% 
  clean_names()%>% 
  mutate(avg_wage = round(as.numeric(avg_wage), digits = 2))

oecd_wage <- oecd_min_wage %>% 
  left_join(oecd_avg_wage, by = c("year", "country"))

```

# UK Indsutry by Region


```{r}
raw_uk_indus_region <- multiplesheets(here("data/raw_data/uk_Labour Productivity - Region by Industry_2019.xls"))
```

```{r}

uk_indus_region <- raw_uk_indus_region$`OpH (value)` %>% 
  slice(-c(1:4))

uk_indus_region[2,1] <- "year"

uk_indus_region_head <- uk_indus_region[1:2,] %>% 
  summarise_all(str_c, collapse=', ') %>% 
  rbind(uk_indus_region) %>% 
  row_to_names(row_number = 1, remove_row = FALSE)

uk_indus_region <- uk_indus_region_head[4:nrow(uk_indus_region_head),] %>% 
  pivot_longer(!'Region, year', names_to = "country", values_to = "oph") %>% 
  separate(country, c("region", "industry"), ", ") %>% 
  separate(industry, c("sic", "industry"), ": ") %>% 
  mutate(oph = round(as.numeric(oph), digits = 2)) %>% 
  rename("year" = 'Region, year') %>% 
  mutate(is_scot = if_else(region == "Scotland", "scotland", "other_uk_regions"),
         countries = case_when(
                  region == "Scotland" ~ "scotland",
                  region == "Wales" ~ "wales",
                  region == "Northern Ireland" ~ "northern_ireland",
                  region == "UK" ~ "uk",
                  TRUE ~ "england"))

us_indus_scot <- uk_indus_region %>% 
  filter(region != "UK") %>% 
  group_by(year, is_scot, sic) %>% 
  summarise(avg_oph = mean(oph))

# Compare Scotland with other regions in UK for "ALL INDUSTRIES"
us_indus_scot_all <- uk_indus_region %>%
  filter(sic %in% "All Industries") %>% 
  group_by(year, countries) %>% 
  summarise(avg_oph = mean(oph)) %>% 
  ungroup() %>% 
  group_by(countries) %>% 
  arrange(countries, year) %>% 
  mutate(rate = (avg_oph - lag(avg_oph))/lag(avg_oph)) %>% 
  ungroup() %>% 
  mutate(
    moving_avg_rate = slide_dbl(
      .x = rate,
      .f = ~mean(.,na.rm = TRUE),
      # 2 weeks moving average
      .before = 2
                        ))


us_indus_scot_all %>% 
  filter(countries %in%  c("scotland", "uk")) %>% 
  ggplot()+
  aes(x = year, y = moving_avg_rate, group = countries, colour = countries, linetype = countries)+
  geom_line()+
  geom_point()+
  # geom_line(aes(x = year, y = rate, group = countries, colour = countries))+
  theme(axis.text.x = element_text(angle = 45))+
    geom_vline(aes(xintercept = "2008"), linetype = "longdash", alpha = 0.5)+
  geom_vline(aes(xintercept = "2018"), linetype = "longdash", alpha = 0.5)+
    annotate(geom = "text",
             label = c("Recession"),
             x = c("2005"),
             y = c(0.06),
             vjust = 1,
           hjust = -.05) +
    annotate(geom = "text",
             label = c("Pandemic"),
             x = c("2015"),
             y = c(0.06),
             vjust = 1,
           hjust = -.05) +  
  labs(title = "2 Years Moving Average Productivity Growth Rate",
       subtitle = "Comparsion between Scotland & the UK")+
  xlab("Year")+
  ylab("Output Per Hour Worked (£)")+
  theme(axis.text.x = element_text(angle = 45))+
  scale_colour_manual(values = c("scotland" = "steelblue", "uk" = "black"))+
  scale_linetype_manual(values = c("scotland" = "solid", "uk" = "dashed"))+
  theme(legend.position="bottom")
```
```{r}
uk_indus_scot_indus_cat <- uk_indus_region %>% 
filter(countries %in% c("uk", "scotland") & sic != "All Industries") %>% 
  mutate(sic = substr(sic,1,1)) %>% 
  left_join(sic_identify_2, by = c("sic" = "sic_cat")) %>% 
  select(-c("region", "sic", "is_scot")) %>% 
  group_by(year, countries, cat) %>% 
  summarise(avg_oph = mean(oph)) %>% 
  pivot_wider(names_from = countries, values_from = avg_oph) %>% 
  mutate(diff_in_oph_percent = 100*((scotland / uk)-1))
  

uk_indus_scot_indus_cat %>%
  filter(cat != c("L", "O-Q", "R-U")) %>% # CHECK 
  ggplot()+
  aes(x = year, y = diff_in_oph_percent, group = cat, colour = cat)+
  geom_line()+
  geom_point()+
  geom_hline(yintercept = 0, linetype = "dashed")+
  labs(title = "2 Years Moving Average Productivity Growth Rate",
       subtitle = "Comparsion between Scotland & the UK")+
  xlab("Year")+
  ylab("Output Per Hour Worked (£)")+
  theme(axis.text.x = element_text(angle = 45))

uk_indus_scot_indus_cat %>% 
    filter(cat != c("L", "O-Q", "R-U")) %>% 
  ggplot()+
  aes(x = year, y = diff_in_oph_percent, group = cat, colour = cat)+
  geom_point()+
  geom_smooth(method = 'lm', se = FALSE)+
  geom_hline(yintercept = 0, linetype = "dashed")+
  labs(title = "Difference in OPH between Scotland and the UK",
       subtitle = "Fitted with simple linear regression model")+
  xlab("Year")+
  ylab("Difference in percentage (%)")+
  theme(axis.text.x = element_text(angle = 45))+
  scale_y_continuous(breaks = seq(-40,40,10))

uk_indus_scot_indus_cat %>% 
  filter(cat %in% c("B-E", "J")) %>% 
  ggplot()+
  aes(x = year, y = diff_in_oph_percent, group = cat, colour = cat)+
  geom_point()+
  geom_smooth(method = 'lm', se = FALSE)+
  geom_hline(yintercept = 0, linetype = "dashed")+
  labs(title = "OPH Difference Summary Per Industry between Scotland and the UK",
       subtitle = "Fitted with simple linear regression model")+
  xlab("Year")+
  ylab("Difference in percentage (%)")+
  theme(axis.text.x = element_text(angle = 45))+
  scale_y_continuous(breaks = seq(-40,40,10))

model1 <- lm(diff_in_oph_percent ~ cat, data = uk_indus_scot_indus_cat)
```
In terms of productivity

The best Scottish industry is B-E (Engineering Industry without construction)

The industry with largest margin is A and show signs of 


uk_indus_scot_indus_cat$countries

```{r}
intercept_coef <- (model1[["coefficients"]][1])

uk_indus_coef <- as.data.frame(model1[["coefficients"]]) %>% 
  rename("coefficient" = c(1)) %>% 
  rownames_to_column(var = "sic_cat") %>% 
  mutate(coefficient = coefficient,
          gradient = round(if_else(coefficient == intercept_coef, intercept_coef, coefficient + intercept_coef), digits = 2))
uk_indus_coef[1,1] <- "catA"

uk_indus_coef %>% 
  arrange(desc(gradient))
```

# UK Industry by World Standard
```{r}
raw_world_prod_indus <- multiplesheets(here("data/raw_data/OECD_prod_indus.xlsx"))
```

```{r}
word_indus_fun = function(name, df) {
  df <- as.data.frame(df) %>% 
        mutate(across(everything(), na_if, "..")) %>% 
        rename("country" = 'Country') %>% 
        pivot_longer(!country, names_to = "year", values_to = "rate_percent") %>% 
        mutate(cat = name)
  
  print(df)
}

world_prod_indus_a   <- word_indus_fun("a", raw_world_prod_indus$a)


world_prod_indus_b_e <- word_indus_fun("b_e", raw_world_prod_indus$b_e)
world_prod_indus_f   <- word_indus_fun("f", raw_world_prod_indus$f)
world_prod_indus_g_i <- word_indus_fun("g_i", raw_world_prod_indus$g_i)
world_prod_indus_j   <- word_indus_fun("j", raw_world_prod_indus$j)
world_prod_indus_k   <- word_indus_fun("k", raw_world_prod_indus$k)
world_prod_indus_m_n <- word_indus_fun("m_n", raw_world_prod_indus$m_n)


# Row Bind everything
world_prod_indus <- world_prod_indus_a %>% 
  rbind(world_prod_indus_b_e, world_prod_indus_f, world_prod_indus_g_i, world_prod_indus_j, world_prod_indus_k, world_prod_indus_m_n) %>% 
  mutate(rate_percent = as.numeric(rate_percent))
```

```{r}
ukfrance_prod_indus <- world_prod_indus %>% 
    filter(country %in% c("United Kingdom", "France")) %>% 
    pivot_wider(names_from = country, values_from = rate_percent) %>% 
    clean_names() %>% 
    mutate(diff_percent = (united_kingdom - france))


ukfrance_prod_indus %>% 
  ggplot()+
  aes(year, diff_percent, group = cat, colour = cat)+
  # geom_point()+
  geom_smooth(method = 'lm', se = FALSE)+
  labs(title = "OPH Difference Summary Per Industry between UK and France",
       subtitle = "Fitted with simple linear regression model")+
  xlab("Year")+
  ylab("Difference in percentage (%)")+
  theme(axis.text.x = element_text(angle = 45))
  ylim(-60,60)
  
  model1 <- lm(diff_in_oph_percent ~ cat, data = uk_indus_scot_indus_cat)
```

#Hypothesis Test

```{r}
  ggplot()+
  aes(x = year, y = diff_in_oph_percent, group = cat, colour = cat)+
  geom_point()+
  geom_smooth(method = 'lm', se = FALSE)+
  geom_hline(yintercept = 0, linetype = "dashed")+
  labs(title = "Difference in OPH between Scotland and the UK",
       subtitle = "Fitted with simple linear regression model")+
  xlab("Year")+
  ylab("Difference in percentage (%)")+
  theme(axis.text.x = element_text(angle = 45))+
  scale_y_continuous(breaks = seq(-40,40,10))
```




```{r}
# # GDP
# g7_gdp <- raw_world_g7$Table_2 %>% 
#   na.omit() %>% 
#   row_to_names(row_number = 1) %>% 
#   clean_names() %>% 
#   mutate(across(c(2:8), as.numeric)) %>% 
#   pivot_longer(!year, names_to = "country", values_to = "gdp")
# 
# g7_gdp_avg <- g7_gdp %>% 
#   filter(country != "uk") %>% 
#   group_by(year) %>% 
#   summarise(g7_avg = mean(gdp)) 
# 
# 
# g7_gdp %>% 
#   ggplot()+
#   geom_line(aes(x = year, y = gdp, group = country, colour = country))+
#   labs(title = "GDP comparison between UK and G7 Countries")+
#   xlab("Year")+
#   ylab("GDP (in million £)")+
#   theme(axis.text.x = element_text(angle = 45))+
#   scale_color_manual(values = c("uk" = "red", "france" = "green"))
```

